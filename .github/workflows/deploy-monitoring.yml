name: Deploy Monitoring Stack

on:
    workflow_dispatch:
        inputs:
            environment:
                description: "Environment to deploy monitoring"
                required: true
                type: choice
                options:
                    - dev
                    - prod
    push:
        branches: [main]
        paths:
            - "k8s/monitoring/**"

jobs:
    deploy-prometheus:
        name: Deploy Prometheus
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up kubectl
              uses: azure/setup-kubectl@v3
              with:
                  version: "latest"

            - name: Configure kubeconfig
              run: |
                  mkdir -p $HOME/.kube
                  echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
                  chmod 600 $HOME/.kube/config

            - name: Add Prometheus Helm repo
              run: |
                  helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
                  helm repo update

            - name: Deploy Prometheus
              run: |
                  helm upgrade --install prometheus prometheus-community/kube-prometheus-stack \
                    --namespace monitoring \
                    --create-namespace \
                    --values k8s/monitoring/prometheus-values-${{ inputs.environment }}.yaml \
                    --wait \
                    --timeout 10m

            - name: Verify Prometheus deployment
              run: |
                  kubectl -n monitoring get pods
                  kubectl -n monitoring wait --for=condition=ready pod -l app.kubernetes.io/name=prometheus --timeout=5m

            - name: Get Prometheus URL
              run: |
                  echo "### ðŸ“Š Monitoring Stack Deployed" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Access Prometheus:**" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                  echo "kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-prometheus 9090:9090" >> $GITHUB_STEP_SUMMARY
                  echo "# Then open http://localhost:9090" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    deploy-grafana:
        name: Configure Grafana Dashboards
        runs-on: ubuntu-latest
        needs: [deploy-prometheus]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up kubectl
              uses: azure/setup-kubectl@v3

            - name: Configure kubeconfig
              run: |
                  mkdir -p $HOME/.kube
                  echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
                  chmod 600 $HOME/.kube/config

            - name: Wait for Grafana to be ready
              run: |
                  kubectl -n monitoring wait --for=condition=ready pod -l app.kubernetes.io/name=grafana --timeout=5m

            - name: Import custom dashboards
              run: |
                  # Get Grafana admin password
                  GRAFANA_PASSWORD=$(kubectl -n monitoring get secret prometheus-grafana -o jsonpath="{.data.admin-password}" | base64 --decode)

                  # Port-forward Grafana in background
                  kubectl -n monitoring port-forward svc/prometheus-grafana 3000:80 &
                  PF_PID=$!
                  sleep 5

                  # Import voting app dashboard
                  if [ -f "k8s/monitoring/dashboards/voting-app-dashboard.json" ]; then
                    curl -X POST -H "Content-Type: application/json" \
                      -u admin:$GRAFANA_PASSWORD \
                      -d @k8s/monitoring/dashboards/voting-app-dashboard.json \
                      http://localhost:3000/api/dashboards/db
                  fi

                  # Cleanup
                  kill $PF_PID

            - name: Get Grafana URL
              run: |
                  GRAFANA_PASSWORD=$(kubectl -n monitoring get secret prometheus-grafana -o jsonpath="{.data.admin-password}" | base64 --decode)

                  echo "**Access Grafana:**" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
                  echo "kubectl port-forward -n monitoring svc/prometheus-grafana 3000:80" >> $GITHUB_STEP_SUMMARY
                  echo "# Then open http://localhost:3000" >> $GITHUB_STEP_SUMMARY
                  echo "# Username: admin" >> $GITHUB_STEP_SUMMARY
                  echo "# Password: $GRAFANA_PASSWORD" >> $GITHUB_STEP_SUMMARY
                  echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

    deploy-loki:
        name: Deploy Loki for Logging
        runs-on: ubuntu-latest
        needs: [deploy-prometheus]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up kubectl
              uses: azure/setup-kubectl@v3

            - name: Configure kubeconfig
              run: |
                  mkdir -p $HOME/.kube
                  echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
                  chmod 600 $HOME/.kube/config

            - name: Add Grafana Helm repo
              run: |
                  helm repo add grafana https://grafana.github.io/helm-charts
                  helm repo update

            - name: Deploy Loki
              run: |
                  helm upgrade --install loki grafana/loki-stack \
                    --namespace monitoring \
                    --values k8s/monitoring/loki-values-${{ inputs.environment }}.yaml \
                    --wait \
                    --timeout 5m

            - name: Verify Loki deployment
              run: |
                  kubectl -n monitoring get pods -l app=loki
                  kubectl -n monitoring wait --for=condition=ready pod -l app=loki --timeout=5m

            - name: Configure Promtail
              run: |
                  echo "**Log Aggregation:**" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… Loki deployed for log aggregation" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… Promtail deployed as DaemonSet for log collection" >> $GITHUB_STEP_SUMMARY

    setup-servicemonitors:
        name: Setup Service Monitors
        runs-on: ubuntu-latest
        needs: [deploy-prometheus]

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up kubectl
              uses: azure/setup-kubectl@v3

            - name: Configure kubeconfig
              run: |
                  mkdir -p $HOME/.kube
                  echo "${{ secrets.KUBECONFIG }}" > $HOME/.kube/config
                  chmod 600 $HOME/.kube/config

            - name: Apply ServiceMonitors
              run: |
                  kubectl apply -f k8s/monitoring/servicemonitors/

            - name: Verify ServiceMonitors
              run: |
                  kubectl get servicemonitors -n voting-app

                  echo "**Service Monitors:**" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… PostgreSQL metrics" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… Redis metrics" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… Application metrics (if exposed)" >> $GITHUB_STEP_SUMMARY

    monitoring-summary:
        name: Monitoring Summary
        runs-on: ubuntu-latest
        needs:
            [
                deploy-prometheus,
                deploy-grafana,
                deploy-loki,
                setup-servicemonitors,
            ]
        if: always()

        steps:
            - name: Summary
              run: |
                  echo "## ðŸ“Š Monitoring Stack Status" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| Prometheus | ${{ needs.deploy-prometheus.result == 'success' && 'âœ… Deployed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Grafana | ${{ needs.deploy-grafana.result == 'success' && 'âœ… Configured' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Loki | ${{ needs.deploy-loki.result == 'success' && 'âœ… Deployed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| ServiceMonitors | ${{ needs.setup-servicemonitors.result == 'success' && 'âœ… Applied' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Quick Access" >> $GITHUB_STEP_SUMMARY
                  echo "1. **Prometheus:** \`kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-prometheus 9090:9090\`" >> $GITHUB_STEP_SUMMARY
                  echo "2. **Grafana:** \`kubectl port-forward -n monitoring svc/prometheus-grafana 3000:80\`" >> $GITHUB_STEP_SUMMARY
                  echo "3. **AlertManager:** \`kubectl port-forward -n monitoring svc/prometheus-kube-prometheus-alertmanager 9093:9093\`" >> $GITHUB_STEP_SUMMARY
