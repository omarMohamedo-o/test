name: Docker Compose Tests

on:
    push:
        branches: [main, develop]
        paths:
            - "docker-compose.yml"
            - "vote/**"
            - "result/**"
            - "worker/**"
            - ".github/workflows/docker-compose-test.yml"
    pull_request:
        branches: [main]

jobs:
    test-docker-compose:
        name: Test Docker Compose Setup
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Start services
              run: |
                  docker compose up -d
                  sleep 30

            - name: Check services are running
              run: |
                  docker compose ps

                  # Check all services are healthy
                  vote_status=$(docker inspect --format='{{.State.Health.Status}}' $(docker compose ps -q vote))
                  result_status=$(docker inspect --format='{{.State.Health.Status}}' $(docker compose ps -q result))

                  if [ "$vote_status" != "healthy" ]; then
                    echo "❌ Vote service is not healthy"
                    docker compose logs vote
                    exit 1
                  fi

                  if [ "$result_status" != "healthy" ]; then
                    echo "❌ Result service is not healthy"
                    docker compose logs result
                    exit 1
                  fi

                  echo "✅ All services are healthy"

            - name: Test vote service
              run: |
                  response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
                  if [ "$response" != "200" ]; then
                    echo "❌ Vote service test failed: HTTP $response"
                    docker compose logs vote
                    exit 1
                  fi
                  echo "✅ Vote service is accessible"

            - name: Test result service
              run: |
                  response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8081)
                  if [ "$response" != "200" ]; then
                    echo "❌ Result service test failed: HTTP $response"
                    docker compose logs result
                    exit 1
                  fi
                  echo "✅ Result service is accessible"

            - name: Submit test vote
              run: |
                  response=$(curl -s -o /dev/null -w "%{http_code}" -X POST -d "vote=a" http://localhost:8080)
                  if [ "$response" != "200" ]; then
                    echo "❌ Vote submission failed: HTTP $response"
                    exit 1
                  fi
                  echo "✅ Vote submitted successfully"

                  # Wait for worker to process
                  sleep 5

            - name: Verify vote in database
              run: |
                  vote_count=$(docker compose exec -T db psql -U postgres -d postgres -t -c "SELECT COUNT(*) FROM votes;")
                  vote_count=$(echo $vote_count | xargs)

                  if [ "$vote_count" -lt "1" ]; then
                    echo "❌ Vote not found in database"
                    docker compose logs worker
                    docker compose logs db
                    exit 1
                  fi

                  echo "✅ Vote stored in database (count: $vote_count)"

            - name: Show logs on failure
              if: failure()
              run: |
                  echo "=== Vote Service Logs ==="
                  docker compose logs vote
                  echo "=== Result Service Logs ==="
                  docker compose logs result
                  echo "=== Worker Service Logs ==="
                  docker compose logs worker
                  echo "=== Redis Logs ==="
                  docker compose logs redis
                  echo "=== PostgreSQL Logs ==="
                  docker compose logs db

            - name: Cleanup
              if: always()
              run: |
                  docker compose down -v

    test-results-summary:
        name: Test Results Summary
        runs-on: ubuntu-latest
        needs: [test-docker-compose]
        if: always()

        steps:
            - name: Summary
              run: |
                  echo "## Docker Compose Test Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  if [ "${{ needs.test-docker-compose.result }}" == "success" ]; then
                    echo "✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "❌ Tests failed" >> $GITHUB_STEP_SUMMARY
                  fi
