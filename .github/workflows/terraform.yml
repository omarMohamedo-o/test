# DISABLED: This workflow provisions cloud infrastructure (AKS/EKS/GKE)
# For local Minikube, no cloud infrastructure is needed
# To re-enable for cloud deployment, uncomment push/pull_request triggers

name: Terraform Infrastructure (DISABLED)

on:
  # Manual trigger only - automatic triggers disabled for local Minikube setup
  workflow_dispatch:
    inputs:
      confirm:
        description: 'WARNING: This provisions cloud resources. Type "confirm" to proceed.'
        required: true
        default: "disabled"
      action:
        description: "Terraform action"
        required: true
        default: "plan"
        type: choice
        options:
          - plan
          - apply
          - destroy
      environment:
        description: "Environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod

env:
  TF_VERSION: "1.6.0"
  WORKING_DIR: "./terraform"

jobs:
  terraform-check:
    name: Terraform Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Format Check
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init -backend=false

      - name: Terraform Validate
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform validate

      - name: Run tflint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: latest

      - name: Initialize tflint
        working-directory: ${{ env.WORKING_DIR }}
        run: tflint --init

      - name: Run tflint
        working-directory: ${{ env.WORKING_DIR }}
        run: tflint --format compact

  terraform-security-scan:
    name: Security Scan (tfsec)
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: ${{ env.WORKING_DIR }}
          format: sarif
          soft_fail: true

      - name: Upload tfsec results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: results.sarif
          category: "terraform"

  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    needs: [terraform-check, terraform-security-scan]
    if: github.event_name == 'pull_request' || github.event.inputs.action == 'plan'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init

      - name: Select environment file
        id: select-env
        run: |
          if [ "${{ github.event.inputs.environment }}" == "prod" ]; then
            echo "tfvars_file=prod.tfvars" >> $GITHUB_OUTPUT
          else
            echo "tfvars_file=terraform.tfvars" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Plan
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          terraform plan \
            -var-file="${{ steps.select-env.outputs.tfvars_file }}" \
            -out=tfplan \
            -no-color

      - name: Upload plan
        uses: actions/upload-artifact@v5
        with:
          name: terraform-plan
          path: ${{ env.WORKING_DIR }}/tfplan
          retention-days: 5

      - name: Comment PR with plan
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const plan = fs.readFileSync('terraform/tfplan.txt', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## Terraform Plan\n\n\`\`\`terraform\n${plan}\n\`\`\``
            });

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-plan]
    if: |
      github.event_name == 'push' && github.ref == 'refs/heads/main' ||
      github.event.inputs.action == 'apply'
    environment:
      name: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init

      - name: Select environment file
        id: select-env
        run: |
          if [ "${{ github.event.inputs.environment }}" == "prod" ]; then
            echo "tfvars_file=prod.tfvars" >> $GITHUB_OUTPUT
          else
            echo "tfvars_file=terraform.tfvars" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Apply
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          terraform apply \
            -var-file="${{ steps.select-env.outputs.tfvars_file }}" \
            -auto-approve

      - name: Terraform Output
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform output -json > terraform-outputs.json

      - name: Upload outputs
        uses: actions/upload-artifact@v5
        with:
          name: terraform-outputs
          path: ${{ env.WORKING_DIR }}/terraform-outputs.json
          retention-days: 30

      - name: Summary
        run: |
          echo "## Terraform Apply Complete âœ…" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Cluster:** voting-app-${{ github.event.inputs.environment || 'dev' }}" >> $GITHUB_STEP_SUMMARY

  terraform-destroy:
    name: Terraform Destroy
    runs-on: ubuntu-latest
    if: github.event.inputs.action == 'destroy'
    environment:
      name: ${{ github.event.inputs.environment }}-destroy

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        working-directory: ${{ env.WORKING_DIR }}
        run: terraform init

      - name: Select environment file
        id: select-env
        run: |
          if [ "${{ github.event.inputs.environment }}" == "prod" ]; then
            echo "tfvars_file=prod.tfvars" >> $GITHUB_OUTPUT
          else
            echo "tfvars_file=terraform.tfvars" >> $GITHUB_OUTPUT
          fi

      - name: Terraform Destroy
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          terraform destroy \
            -var-file="${{ steps.select-env.outputs.tfvars_file }}" \
            -auto-approve

      - name: Summary
        run: |
          echo "## Terraform Destroy Complete ðŸ—‘ï¸" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Resources destroyed" >> $GITHUB_STEP_SUMMARY
